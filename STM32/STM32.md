# STM32

## 一、启动文件

汇编文件刚开始先开辟C语言的运行环境（堆栈的开辟），把栈顶地址放在中断向量表开头的位置，向量表第二位存放复位
```c
Reset_Handler    PROC
                 EXPORT  Reset_Handler             [WEAK]
     IMPORT  __main
     IMPORT  SystemInit
                 LDR     R0, =SystemInit
                 BLX     R0
                 LDR     R0, =__main
                 BX      R0
                 ENDP
```
代码段首先执行`systeminit()`，对向量表进行重映射到0x0地址，老版代码还会对HLI时钟初始化，刚上电时使用的时钟为高速内部时钟
然后调用`__main()`，进行堆栈的初始化，并跳转到主函数中运行



------



二、系统滴答定时器
---

`HAL_Init()`中调用`HAL_InitTick()`进行默认的初始化
随后在`SystemClock_Config()`中根据新的时钟配置调用`HAL_InitTick()`进行初始化

`HAL_Delay()`的实现是根据系统滴答定时器来实现，在中断中调用`HAL_IncTick()`对`uwTickFreq`值进行加一
注意：新版本中断优先级默认为15，最好根据需要调整为0，否则如果在其他中断处理函数使用`HAL_Delay()`会因为滴答定时器中断优先级太低而卡死



------



三、外设
---

### 1.UART

#### 1.1 概述

通用异步收发器，是一种通用的串行、异步通信总线，该总线有两条数据线，可以实现全双工的发送和接收，在嵌入式系统中常用于主机与辅助设备之间的通信

#### 1.2 UART数据帧格式

![image-20221015164438479](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101305707.png)

**一般一次发送8位一字节，为了防止异步通信时间基准不一样，避免累计误差。**



#### 1.3 功能框图

![image-20221015164645451](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101305648.png)



发送数据时，先将待发送的数据写入TDR寄存器中，然后TDR寄存器再把数据写入到发送移位寄存器，然后移位寄存器将数据一位一位的通过引脚发送出去

接收数据时，接收移位寄存器将引脚数据一位一位接收，然后写入到RDR寄存器中，最后读取RDR寄存器就可得到接收的数据



#### 1.4 操作步骤

串口发送数据步骤：
①使能发送器----->配置CR1寄存器
②判断发送寄存器TDR是否为空----->读状态寄存器
③将数据写入TDR

串口接收数据步骤：
①使能接收器----->配置CR1寄存器
②判断接收寄存器RDR是否接收到数据------>读状态寄存器
③读取RDR



#### 1.5 中断请求

![image-20221015164709996](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101305305.png)



### 2.定时器

#### 2.1 时钟源

* HSI(高速内部时钟)，采用RC振荡电路，系统刚上电时默认时钟源

* HSE(高速外部时钟)，可以接晶振

* LSI(低速内部时钟)，RC振荡电路，供给独立看门狗使用

* LSE(低俗外部时钟)

  

#### 2.2 定时器中断类别

- 更新中断：计数器溢出时，产生更新中断，溢出后会自动读取重装载的值
- 捕获中断：捕获到触发源



#### 2.3 影子寄存器

![image-20221015164722301](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101305340.png)
PSC和ARR都有影子寄存器
**影子寄存器的存在起到一个缓冲的作用，用户值->寄存器->影子寄存器->起作用。**
例如，使能影子寄存器，ARR 初始值为 ARR1，定时器工作后，想改变ARR值为 ARR2，但是写操作后不会立即起作用，而是在当前计数周期完成，产生更新事件/中断之后，在下一个周期开始的时候才改变影子寄存器的值。该功能叫做自动重装载预装载(auto-reload preload)，可以在Cube中配置



### 3.DMA

#### 3.1 DMA数据仲裁

如果有多个外设请求DMA，则需要仲裁，配置 DMA_SxCR寄存器 PL[1:0]位，可以设置为非常高、高、中和低四个级别
如果两个或以上数据流软件设置优先级一样，则他们优先级取决于数据流编号，编号越低越具有优先权

#### 3.2 FIFO

每个数据流都有一个独立的 4 字 FIFO(先进先出存储器缓冲区)。 DMA传输具有 FIFO模式和直接模式。
直接模式：一旦外设触发 DMA 请求时则立即传输数据。
FIFO模式：设置FIFO 阈值级别为 FIFO 大小的 1/4、1/2 或 3/4。如果数据存储量达到阈值级别时，FIFO 内容将传输到目标中。

注意：DMA1 只有外设到存储器和存储器到外设两种模式，DMA2 除前面两种外还支持存储器到存储器的传输模式。

#### 3.3 DMA中断请求

![image-20221015164739522](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101305834.png)



#### 3.4 DMA中断回调：

DMA对应多种外设，所以HAL库**没有**对每个外设设置**专门的回调函数**，而是提供一个指针指向各个外设回调函数。
指针`hadc->DMA_Handle->XferCpltCallback`



例如ADC：
在`HAL_ADC_Start_DMA()`中会对DMA回调指针进行赋值------`hadc->DMA_Handle->XferCpltCallback = ADC_DMAConvCplt;`
在`ADC_DMAConvCplt()`中调用`HAL_ADC_ConvCpltCallback(hadc);`，重写该函数实现DMA回调




----------

### 4.ADC

#### 4.1 ADC量程

ADC量程由VREF+、VREF-、VDDA、VSSA四个引脚决定，   VREF-<量程<VREF+，开发板接的3.3V，所以量程为0到3.3



#### 4.2 分辨率

分辨率越高，表示能测量更小的量程，例如开发板12位分辨率，最小能测3.3/4096V的电压



#### 4. 3 数据寄存器ADC_DR

数据寄存器为32位，但只有16位有效，而ADC分辨率为12位，因此存放数据时选择右对齐方式。由于数据寄存器只有一个，当多通道采集时，需要及时提取数据

**多通道采集最好使用DMA，一个通道转换完能够产生DMA请求**



#### 4.4 ADC中断类别：

- 转换结束中断：每个通道转换完成将产生中断
- 模拟看门狗中断：ADC转换的模拟电压低于或高于阈值，则产生中断
- 溢出中断：DMA数据丢失，会产生溢出中断
- DMA请求：转换结束后可以产生DMA请求



#### 4.5 单次转换

* 开启ADC转换 ----->设置ADC_CR2寄存器中的ADON
* 转换数据被存储在ADC_DR寄存器中
* EOC(转换结束)标志被设置
* 如果设置了EOCIE，则产生中断



#### 4.6 连续转换

当前面ADC转换一结束马上就启动另一次转换

* 开启ADC转换 ----->设置ADC_CR2寄存器中的ADON
* 开启连续转换------>设置ADC_CR2寄存器中的CONT
* 转换数据被存储在ADC_DR寄存器中
* EOC(转换结束)标志被设置
* 如果设置了EOCIE，则产生中断



#### 4.7 扫描模式

ADC扫描选择的所有通道，在每一个组的每个通道上依次执行单次转换。如果设置了CONT(连续转换)，则一直转换
如果设置了DMA，在每次EOC(转换结束)后，ADC会把转换数据传输到SRAM中



### 5.I2C

两线式串行总线，一条串行数据SDA，一条串行时钟线SCL

#### 5.1 物理结构图

![image-20221015164754516](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101306061.png)

在总线空闲状态时，这两根线一般被上面所接的上拉电阻拉高，保持着**高电平**。



#### 5.2 I2C总线协议

数据传输以**字节**为单位 , 主设备在SCL线上产生每个时钟脉冲的过程中将在SDA线上传输一个数据位，从高位到低位进行传输

方向位： 0表示主设备向从设备写数据，1表示主设备向从设备读数据



应答信号：接收数据的器件在接收到 8bit 数据后，向发送数据的器件发出低电平的应答信号，表示已收到数据

![image-20221015164804988](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101306837.png)



> 数据在SCL高电平时被采样，低电平时进行数据位变换，当时SCL为高电平时，SDA由高变低表示开始，由低变高表示停止





### 6.SPI

#### 6.1 SPI接口是全双工三线同步串行接口

![image-20221015164819880](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101306388.png)



一共四根线：SCK(时钟线)，MOSI(主机发送从机接收)、MISO(从机发送主机接收)、NSS(片选线)

#### 6.2 总线协议

![image-20221015164829096](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101306505.png)

起始信号：NSS信号线由高变低，是SPI通讯的起始信号
结束信号：NSS信号由低变高，是SPI通讯的停止信号
数据传输：MOSI及MISO数据线在SCK的每个时钟周期传输一位数据，且数据输入输出是同时进行的。SPI每次数据传输可以 8 位或 16 位为单位，每次传输的单位数不受限制

#### 6.3 SPI四种通信方式

![image-20221015164838299](https://liepinote.oss-cn-beijing.aliyuncs.com/test/202303101306371.png)